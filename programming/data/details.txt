=======
明细表
=======

在框架中，明细表用于处理与项目表中记录相关的表格数据。

例如，演示应用程序中的 **Invoices** （发票）日志拥有
**InvoiceTable** （发票表格）明细表，用于保存客户发票中的曲目列表。

明细表和明细表项目共享相同的底层数据库表。

要创建明细表，您必须首先创建一个明细表项目（选择项目树中的 Details（明细表）组，
然后点击 New（新建）按钮），然后使用
:doc:`明细表对话框 </admin/items/details_dialog>`
（在项目树中选择项目，然后点击 Details（明细表）按钮）
将明细表添加到项目中。

例如，以下代码

.. code-block:: py

    def on_created(task):
        task.invoice_table.open()
        print  task.invoice_table.record_count()
    
        task.invoices.open(limit=1)
            task.invoices.invoice_table.open()	
        print task.invoices.invoice_table.record_count()

将打印：::

    2259
    6

在 Jam.py v5 中，明细表有两个
:doc:`公共字段 <common_fields>` -
``master_id`` 和 ``master_rec_id``，用于存储有关主表
``ID`` 的信息（每个项目都有自己唯一的 ID）以及其主表记录的主字段值。
这样，每个表都可以链接到多个项目。同样，每个项目也可以有多个明细表。
要访问项目的明细表，请使用其 ``details`` 属性。要访问明细表的主表，
请使用其 ``master`` 属性。

在 Jam.py v7 中，上述两个字段不存在，但对于迁移的 v5 应用程序，它们仍受支持。
Jam.py v7 应用程序将使用查找字段作为主表的明细表，通常作为外键字段。

用于创建明细表的 Detail 类是 Item 类的祖先，并
继承了其所有属性、方法和事件。

.. note::

    Detail 类的 ``apply`` 方法不执行任何操作。要保存对明细表所做的更改，
    请使用其主表的 ``apply`` 方法。
    
    要使用明细表，其主表必须处于活动状态。
    
    要对明细表进行任何更改，其主表必须处于编辑或插入模式。

示例
========

在这个来自
:doc:`演示项目 </intro/demo_project>` 的 **Invoices** （发票）项目客户端模块的示例中，
每次其主表的游标移动到另一条记录时， **Invoice_table** （发票表格）明细表都会重新打开。

.. code-block:: js

    var ScrollTimeOut;
    
    function on_after_scroll(item) {
        clearTimeout(ScrollTimeOut);
        ScrollTimeOut = setTimeout(
            function() {
                item.invoice_table.open(function() {});
            },
            100
        );
    }

以下是一个示例：

.. code-block:: py

    from datetime import datetime, timedelta

    def on_created(task):
        invoices = task.invoices.copy()
        invoices.set_where(invoicedate__gt=datetime.now()-timedelta(days=1))
        invoices.open()
        for i in invoices:
            i.invoice_table.open()
            i.edit()
            for t in i.invoice_table:
                t.edit()
                t.sales_id.value = '101010'
                t.post()
            i.post()
        invoices.apply()
    
客户端上的相同代码如下：

.. code-block:: js

    function on_page_loaded(task) {
        var date = new Date(),
            invoices = task.invoices.copy();
        
        invoices.set_where({invoicedate__gt: date.setDate(date.getDate() - 1)});
        invoices.open();
        invoices.each(function(i) {
            i.invoice_table.open();
            i.edit();
            i.invoice_table.each(function(t) {
                t.edit();
                t.sales_id.value = '101010';
                t.post();
            });
            i.post();
        });
        invoices.apply();
    }





    
